#!/usr/bin/perl -w
$version = "1.00" ;


sub DirDump    ; # Forward declaration
sub Println    ; # print args + nl 
sub SetupOS    ; # Setup variables list SEP and so on
sub MakePath   ; # Combine a directory and filename into path
sub Welcome    ; # Show the welcome notice
sub PrintFiles ; # Show the welcome notice

$onehour    = 3600            ;
$oneday     =  24 * $onehour  ;
$twoday     =   2 * $oneday   ;
$threeday   =   3 * $oneday   ;
$oneday     =  24 * $onehour  ;
$oneweek    =   7 * $oneday   ;
$onemonth   =  30 * $oneday   ;
$oneyear    = 365 * $oneday   ;
$twoyear    =   2 * $oneyear  ;
$threeyear  =   3 * $oneyear  ;


my @Oneday   ;
my @Twoday   ;
my @Threeday ;
my @Oneweek  ;
my @Onemonth ;
my @Oneyear  ;
my @Twoyear  ;
my @Threeyear;
my @Files    ;
my $files    ;

#
#  Show the welcome message
#
Welcome("Tree","tree dumping utility",$version)  ;

sub Syntax 
{
   print  "Useage: urls directory url\n" ;
   printf "Eg:     urls Y:\projects\PTG-Core\Copernicus\Documents http://janeway.corp.adobe.com/PTG-Core/Copernicus/Documents\n\n" ;
   die ;
}
#
#  Get our arguments
#
# @args = scalar @ARGV ?  @ARGV :(".") ;

$arg        = shift or Syntax ;
$url        = shift or Syntax ; 

print "<HTML><HEAD><TITLE>AgeSort Page</TITLE></HEAD><BODY bgcolor=#FFFFFF>\n" ;
print "<H2>AgeSorting  $arg </p>\n<table>" ;

my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime time ;

@WDays  = ( "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat") ;
@Months = ( "Jan", "Feb", "Mar", "Apr", "May", "Jun"
          , "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
          ) ;

$mon   = $Months[$mon] ;
$wday  = $WDays[$wday] ;
$year += 1900 if $year < 1900 ;

print "<p>Time = $hour:$min:$sec  Date = $wday $mday/$mon/$year</p>\n" ;

DirDump($arg ,$url) ;
@files = @Oneday    ; PrintFiles "Files younger than 1 day"   ;
@files = @Twoday    ; PrintFiles "Files younger than 2 days"  ;
@files = @Threeday  ; PrintFiles "Files younger than 3 days"  ;
@files = @Oneweek   ; PrintFiles "Files younger than 1 week"  ;
@files = @Onemonth  ; PrintFiles "Files younger than 1 month" ;
@files = @Oneyear   ; PrintFiles "Files younger than 1 year"  ;
@files = @Twoyear   ; PrintFiles "Files younger than 2 years" ;
@files = @Threeyear ; PrintFiles "Files younger than 3 years" ;
@files = @Files     ; PrintFiles "Files older   than 3 year"  ;
print "</table>\n" ;
print "</BODY></HTML>\n" ;

# -------------------------------------
# Welcome - 
# -------------------------------------
sub Welcome
{
  my ( $name,$desc,$version ) = @_ ;

  my $bNT = SetupOS() ;
}

# -------------------------------------
# PrintFiles - print a list of files
# -------------------------------------
sub PrintFiles
{
  return if !scalar @files  ;

  my      $msg   = shift  ;
  my      $file           ;
  print   "<TR><TD VALIGN=Top><B>$msg</B></TD><TD VALIGN=Top>"     ;
  foreach $file ( @files ) {
    print "<A HREF=$file>$file</A></BR>\n"  ;
  }
  print "</TD></TR>" ;
}

# -------------------------------------
# Println - print arguments with space and \n
# -------------------------------------
sub Println
{
  my      $arg     ;
  my      $i = $_  ;
  foreach $arg ( @_ ) {
    $i -- ;
    print $arg . ( $i ? " " : "\n" ) ;
  }
}

# -------------------------------------
# SetupOS - 
# -------------------------------------
sub SetupOS
{
    my $result = $^O =~ m:^mswin32:i ; # is OSNAME == mswin32 ?
    $PATH_SEP  =$result?  "\\" : "/" ; # PATH_SEP = \ on NT and / on UNIX
    return $result ;
}

# -------------------------------------
# MakePath
# -------------------------------------
sub MakePath
{
    return $_[0] . $PATH_SEP . $_[1] ;
}

sub GetTime
{
    my $t = shift ;
    my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime $t ;
    $year = 1900 + $year ;

    @WDays  = ( "Sunday" , "Monday"  , "Tuesday"  , "Wednesday", "Thursday", "Friday", "Saturday" ) ;
    @Months = ( "January", "February", "March"    , "April"    , "May"     , "June"
              , "July"   , "August"  , "September", "October"  , "November", "December"
              ) ;

    $mon   = $Months[$mon] ;
    $wday  = $WDays[$wday] ;

    $t = sprintf("%s %s/%s/%02d %02d:%02d:%02d",$wday,$mday,$mon,$year,$hour,$min,$sec,) ;
    return $t ;
}

# -------------------------------------
# DirDump
# -------------------------------------
sub DirDump {
  my $dir   = shift ;
  my $URL   = shift ;
  my $total = 0     ;
  my $now   = time  ;
  my $path ;

  opendir     DIRECTORY, $dir ;
  my @files = readdir DIRECTORY       ;
              closedir DIRECTORY      ;

  #
  # Report every file
  #
  foreach $file (@files) {
    $file = $file    ;
    next if ( $file eq '.' || $file eq '..' ) ;

    my $path = MakePath($dir,$file) ;
    my $url  = $URL . "/" . $file   ;
    my ($dev,$ino,$mode,$nlink,$uid,$gid,$rdev,$size,
           $atime,$mtime,$ctime,$blksize,$blocks)
               = stat($path);

    $total += $size ;

    if ( ! -d $path ) {
      my $age = $now - $mtime ;
      # $path = sprintf ("%-40s %s",GetTime($mtime) , $path)  ;

      if ( $age < $oneday ) {
        push @Oneday,$url  ;
      } elsif ( $age < $twoday ) {
        push @Twoday,$url ;
      } elsif ( $age < $threeday ) {
        push @Threeday,$url ;
      } elsif ( $age < $oneweek ) {
        push @Oneweek,$url ;
      } elsif ( $age < $onemonth ) {
        push @Onemonth,$url ;
      } elsif ( $age < $oneyear ) {
        push @Oneyear,$url ;
      } elsif ( $age < $twoyear ) {
        push @Twoyear,$url ;
      } elsif ( $age < $threeyear ) {
        push @Threeyear,$url ;
      } else {
        push @Files,$url ;
      }
    }
  }

  #
  # Recurse every directory
  #
  foreach $file (@files) {
    next if ( $file eq '.' || $file eq '..' ) ;

    my $path = MakePath($dir,$file) ;
    my $url  = $URL . "/" . $file   ;
    if ( -d $path ) {
      $total += DirDump($path,$url) ;
    }
  }
  return $total ;
}

