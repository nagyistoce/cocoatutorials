#!/usr/bin/perl

# use strict;
# use warnings;

##
# public modules
use XML::Parser::Expat;
use File::Basename;
use Math::Trig;
use Imager;
use Cwd;

##
# our module
use lib "$ENV{PWD}/";
use lib "$ENV{HOME}/bin";
use Collage;

##
# globals
my $name ; # name of collage
my $w    ; # width of collage (on the web page)
my $h    ; # height of collage (on the web page)

#############################################
##
# functions and forward declarations
sub syntax
{
	Collage::error("usage: mkcollage name [w]") ;
}

##
# fixup: template -> instance conversion
sub fixup
{
	my $s=shift;
	
    my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime time ;
    
    @WDays  = ( "Sunday" , "Monday"  , "Tuesday"  , "Wednesday", "Thursday", "Friday" , "Saturday") ;
    @Months = ( "January", "February", "March"    , "April"    , "May"     , "June"
              , "July"   , "August"  , "September", "October"  , "November", "December"
              ) ;
    
    $smon  = $Months[$mon] ;
    $wday  = $WDays[$wday] ;
    $year += 1900 if $year < 1900 ;
    $mon++ ;
    
    my $date = "$smon $mday, $year";
    
    my $width = 150;
    my $WIDth = $w - $width;
    
	# http://sunsite.ualberta.ca/Documentation/Misc/perl-5.6.1/pod/perllol.html
	my @P  = ( ['__YEAR__' 				,"$year" ]
	         , ['__DATE__' 				,"$date" ]
	         , ['__DAY__'  				,"$wday" ]
	         , ['__WIDTH__'				,"$w"    ]
	         , ['__WIDth__'				,"$WIDth"]
	         , ['__width__'				,"$width"]
	         , ['__NAME__'              ,"$name" ]
	         , ['/2012/NewYearsDay'    	, '/2011/Christmas/NewYearsDay'] # New Year 2011 correction
	         , ['AppleOffice/IMG_3502' 	, 'Apple']                       # New Year 2011 correction
	         , ["$ENV{PHOTOS}/"        	, '/'    ]
	         );
	for my $i (0 .. $#P) {
		my $p=$P[$i][0];
		my $q=$P[$i][1];
		# http://www.perlmonks.org/?node_id=98357
		my $S = $s;
		$s   =~ s#\Q$p\E#$q#g;
		
		# 	print "sub '$p' -> '$q'\n";
		# 	print "$S\n";
		# 	print "$s\n";
		# 	print "--------------------\n";
	}

	return $s;
}
#
#############################################

#############################################
# main program

##
# Get the command line arguments
$name = shift or syntax() ;
$w    = shift or 0 ;
$w    = 550 if !$w ;

##
# Find the photo and collage data
my $home    = $ENV{"HOME"} ;
my $path    = "${home}/Pictures/Picasa/Collages/${name}" ;
my $photo   = $path . ".jpg" ;
my $collage = $path . ".cxf" ;

Collage::error("picture does not exist $photo"  ) if ( ! -e $photo     ) ;
Collage::error("collage does not exist $collage") if ( ! -e $collage   ) ;

##
# open and resample the image
my $image = Imager->new(file=>$photo) or die "Cannot load $photo: ", $image->errstr;
my $W =   $image->getwidth;
my $H =   $image->getheight;
   
my $s = $w / $W ;
Collage::println("W = " . $W) ;
Collage::println("H = " . $H) ;
Collage::println("s = " . $s) ;

# Create smaller version
# documented in Imager::Transformations
# Autostretch individual channels
my $thumb = $image->scale(scalefactor=>$s);
   $thumb->filter(type=>'autolevels');
   
my $thumbname = $name . '.jpg';
$thumb->write(file=>$thumbname) or die $thumb->errstr;

$w = $thumb->getwidth;
$h = $thumb->getheight;
Collage::println("w = " . $w) ;
Collage::println("h = " . $h) ;

##
# get the imagemap
Collage::println("readcollage $collage $w $h \"" . $file . '"') ;
my  @lines = Collage::read($collage,$w,$h);

##
# write the files
my   $html = $name . ".shtml";
open (HTML,"> $html") ;
print HTML fixup(Collage::getShtml()) ;
close(HTML) ;

my   $file  = $name . ".inc"  ;
open (FILE,"> $file") ;
print FILE fixup(Collage::getHead())  ;
foreach my $line (@lines) {
	print FILE fixup($line) . "\n" ; 
}
print FILE fixup(Collage::getTail())  ;
close(FILE) ;

##
# and show it
my $url = fixup("http://localhost/Homepages/__YEAR__/$html");
Collage::println("open \"$url\"") ;
system          ("open \"$url\"") ;

#
#############################################

1;
# That's all Folks!
##
