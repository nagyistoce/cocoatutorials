#!/bin/csh

set echo=0

#
# WARNING:  This script is not tested AT ALL
#           It's a skeleton for what might be needed
#
# 

#
# You should increment these with every build
#
setenv SC_BUILD_IDENTIFIER     1.0.3.77
setenv SC_BUILD_SUBIDENTIFIER          .14
setenv SC_BUILD_COMMENT        "whatever this build is about"


# ------------------------------
# setup the environment
# to logon to other servers
setenv SC_USER         rmills
setenv SC_PASSWORD     Largs12@
# location of ReadMe.pdf
setenv SC_README       ReadMe.pdf

# Perforce
setenv P4CLIENT RobinsUnix
setenv P4PASSWD Largs12@
setenv P4USER   rmills
setenv P4PORT   redcloud:1850

# Where's ESTK in Perforce and on the disk?
#
setenv SC_CLIENTSPEC    /1850/releases/ct/hazel_didv/extendscript/ide/public/libraries/macintosh/release
setenv SC_PERFORCESPEC      //releases/ct/hazel_didv/extendscript/ide/public/libraries/macintosh/release

# Where does the installer and updater get built on disk?
#
setenv SC_UPDATER   "ami/packages/pkg_application/build/Adobe ExtendScript Toolkit 1.0.3.dmg"
setenv SC_INSTALLER "ami/packages/pkg_application/build/Adobe ExtendScript Toolkit 1.0.0.dmg"

# Output server
#
setenv SC_NEPTUNE_CT /Volumes/CoreTech

setenv SC_TODAYSDATE `date`
#
# ------------------------------

#
# mount the output server
# I can't get umount to work, so I've commented this off
#
# mkdir /Volumes/CoreTech
# mount_afp afp://${SC_USER}:${SC_PASSWORD}@neptune/CoreTech ${SC_NEPTUNE_CT}

# -------------------------------------------------------------------------
#
# 1 sync the head revision on DIDV
#
p4 -f sync SC_PERFORCESPEC

#
# 2 copy ESTK to Adobe Utilities
#

pushd SC_CLIENTSPEC
  ditto "ExtendScript Toolkit.app" "ami/packages/pkg_application/root/Utilities/Adobe Utilities.localized"
popd

#
# 3 copy ReadMe.pdf to the correct place
#
cp $SC_README ami/packages/pkg_application/ReadMe.pdf


#
# 4 Open a terminal window (we've already got that in the shell)
#

#
# 5 make the installer and updater
#
sudo make BUILD_NUMBER=SC_BUILD_IDENTIFIER

#
# 6 Create an output folder on Neptune for the installer
#
mkdir                  "${SC_NEPTUNE_CT}/QE/Transfer/ESTK/Sub-Installer/ESTK Mac/${BUILD_IDENTIFIER}${BUILD_SUBIDENTIFIER}
ditto "${SC_INSTALLER} "${SC_NEPTUNE_CT}/QE/Transfer/ESTK/Sub-Installer/ESTK Mac/${BUILD_IDENTIFIER}${BUILD_SUBIDENTIFIER}

#
# 7 Update Mac Sub-Installers.txt
#
sed "${NEPTUNE_CT}/QE/Transfer/ESTK/Sub-Installer/ESTK Mac/Sub-Installlers.txt"
+++  "${TODAYSDATE} ${USER} ${BUILD_CHANGES}


#
# Use a local perl script to update the comments file
#
perl << "SCRIPT"

#
# Read in the file
#
open(FILE,"<Sub-Installlers.txt") ;
my @lines ;
while ( $line = <FILE> ) {
  push @lines,$line ;
}
close FILE              ;
 
# -----------------------
# what's the local time?
 
my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime(time);
 
$mon  += 1    ;
$year += 1900 ;
my $now = "$mon/$mday/$year $hour:$min:$sec" ;
# print $now ;
 

# ------------------------
# update the file
#
$change = $ENV{SC_BUILD_COMMENT} ;
open (FILE,">Sub-Installlers.txt") ;
print FILE  ;
print FILE  ;
print FILE "#-----------\n#Date " . $now . " " . $change . "\n#\n"    ;
 
foreach $line ( @lines ) {
  print FILE $line ;
}
 
close FILE ;
# print @lines ;

"SCRIPT"

# end of local script
# ------------------------------------------



#
# 8 copy the updater to the server
#
ditto $SC_UPDATER "${SC_NEPTUNE_CT}/QE/Transfer/ESTK/Sub-Installer/ESTK Mac/AUM Build"

#
# 9 rename folder in the AUM folder
#
pushd "${SC_NEPTUNE_CT}/QE/Transfer/ESTK/Sub-Installer/ESTK Mac/AUM Build
  mv  "latest*" "latest version${SC_BUILD_IDENTIFIER}$${SC_BUILD_SUBIDENTIFIER}
popd

#
# cleanup - unmount the file system (doesn't seem to work!)
#
# umount -h ${SC_NEPTUNE}


echo That's all folks
